{"ast":null,"code":"/*\n * Copyright (c) 2018 by Filestack\n * Some rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as tslib_1 from \"tslib\";\nimport { EventEmitter } from 'eventemitter3';\nimport * as Sentry from '@sentry/minimal';\nimport { config } from '../config';\nimport { FilestackError } from './../filestack_error';\nimport { metadata, remove, retrieve } from './api/file';\nimport { transform } from './api/transform';\nimport { storeURL } from './api/store';\nimport { resolveHost, getVersion } from './utils';\nimport { Upload } from './api/upload';\nimport { preview } from './api/preview';\nimport { CloudClient } from './api/cloud';\nimport { picker } from './picker';\n/* istanbul ignore next */\n\nSentry.addBreadcrumb({\n  category: 'sdk',\n  message: 'filestack-js-sdk scope'\n});\n/**\n * The Filestack client, the entry point for all public methods. Encapsulates session information.\n *\n * ### Example\n * ```js\n * // ES module\n * import * as filestack from 'filestack-js';\n * const client = filestack.init('apikey');\n * ```\n *\n * ```js\n * // UMD module in browser\n * <script src=\"https://static.filestackapi.com/filestack-js/3.x.x/filestack.min.js\"></script>\n * const client = filestack.init('apikey');\n * ```\n */\n\nvar Client =\n/** @class */\nfunction (_super) {\n  tslib_1.__extends(Client, _super);\n\n  function Client(apikey, options) {\n    var _this = _super.call(this) || this;\n    /* istanbul ignore next */\n\n\n    Sentry.configureScope(function (scope) {\n      scope.setTag('apikey', apikey);\n      scope.setTag('sdk-version', getVersion());\n      scope.setExtra('clientOptions', options);\n    });\n\n    if (!apikey || typeof apikey !== 'string' || apikey.length === 0) {\n      throw new Error('An apikey is required to initialize the Filestack client');\n    }\n\n    var urls = config.urls;\n    _this.session = {\n      apikey: apikey,\n      urls: urls\n    };\n\n    if (options) {\n      var cname = options.cname,\n          security = options.security;\n\n      _this.setSecurity(security);\n\n      _this.setCname(cname);\n    }\n\n    _this.cloud = new CloudClient(_this.session, options);\n    return _this;\n  }\n  /**\n   * Set security object\n   *\n   * @param {Security} security\n   * @memberof Client\n   */\n\n\n  Client.prototype.setSecurity = function (security) {\n    if (security && !(security.policy && security.signature)) {\n      throw new FilestackError('Both policy and signature are required for client security');\n    }\n\n    if (security && security.policy && security.signature) {\n      this.session.policy = security.policy;\n      this.session.signature = security.signature;\n    }\n  };\n  /**\n   * Set custom cname\n   *\n   * @param {string} cname\n   * @returns\n   * @memberof Client\n   */\n\n\n  Client.prototype.setCname = function (cname) {\n    if (!cname || cname.length === 0) {\n      return;\n    }\n\n    this.session.cname = cname;\n    this.session.urls = resolveHost(this.session.urls, cname);\n  };\n  /**\n   * Clear all current cloud sessions in the picker.\n   * Optionally pass a cloud source name to only log out of that cloud source.\n   * This essentially clears the OAuth authorization codes from the Filestack session.\n   * @param name Optional cloud source name.\n   */\n\n\n  Client.prototype.logout = function (name) {\n    return this.cloud.logout(name);\n  };\n  /**\n   * Retrieve detailed data of stored files.\n   *\n   * ### Example\n   *\n   * ```js\n   * client\n   *   .metadata('DCL5K46FS3OIxb5iuKby')\n   *   .then((res) => {\n   *     console.log(res);\n   *   })\n   *   .catch((err) => {\n   *     console.log(err);\n   *   }));\n   * ```\n   * @see [File API - Metadata](https://www.filestack.com/docs/api/file#metadata).\n   * @param handle Valid Filestack handle.\n   * @param options Metadata fields to enable on response.\n   * @param security Optional security override.\n   */\n\n\n  Client.prototype.metadata = function (handle, options, security) {\n    /* istanbul ignore next */\n    return metadata(this.session, handle, options, security);\n  };\n  /**\n   * Construct a new picker instance.\n   */\n\n\n  Client.prototype.picker = function (options) {\n    /* istanbul ignore next */\n    return picker(this, options);\n  };\n  /**\n   * Used for viewing files via Filestack handles or storage aliases, __requires Document Viewer addon to your Filestack application__.\n   * Opens document viewer in new window if id option is not provided.\n   *\n   * ### Example\n   *\n   * ```js\n   * // <div id=\"preview\"></div>\n   *\n   * client.preview('DCL5K46FS3OIxb5iuKby', { id: 'preview' });\n   * ```\n   * @param handle Valid Filestack handle.\n   * @param options Preview options\n   */\n\n\n  Client.prototype.preview = function (handle, options) {\n    /* istanbul ignore next */\n    return preview(this.session, handle, options);\n  };\n  /**\n   * Remove a file from storage and the Filestack system.\n   *\n   * __Requires a valid security policy and signature__. The policy and signature will be pulled from the client session, or it can be overridden with the security parameter.\n   *\n   * ### Example\n   *\n   * ```js\n   * client\n   *   .remove('DCL5K46FS3OIxb5iuKby')\n   *   .then((res) => {\n   *     console.log(res);\n   *   })\n   *   .catch((err) => {\n   *     console.log(err);\n   *   }));\n   * ```\n   * @see [File API - Delete](https://www.filestack.com/docs/api/file#delete)\n   * @param handle Valid Filestack handle.\n   * @param security Optional security override.\n   */\n\n\n  Client.prototype.remove = function (handle, security) {\n    /* istanbul ignore next */\n    return remove(this.session, handle, false, security);\n  };\n  /**\n   * Remove a file **only** from the Filestack system. The file remains in storage.\n   *\n   * __Requires a valid security policy and signature__. The policy and signature will be pulled from the client session, or it can be overridden with the security parameter.\n   *\n   * ### Example\n   *\n   * ```js\n   * client\n   *   .removeMetadata('DCL5K46FS3OIxb5iuKby')\n   *   .then((res) => {\n   *     console.log(res);\n   *   })\n   *   .catch((err) => {\n   *     console.log(err);\n   *   }));\n   * ```\n   * @see [File API - Delete](https://www.filestack.com/docs/api/file#delete)\n   * @param handle Valid Filestack handle.\n   * @param security Optional security override.\n   */\n\n\n  Client.prototype.removeMetadata = function (handle, security) {\n    /* istanbul ignore next */\n    return remove(this.session, handle, true, security);\n  };\n  /**\n   * Store a file from its URL.\n   *\n   * ### Example\n   *\n   * ```js\n   * client\n   *   .storeURL('https://d1wtqaffaaj63z.cloudfront.net/images/NY_199_E_of_Hammertown_2014.jpg')\n   *   .then(res => console.log(res));\n   * ```\n   * @see [File API - Store](https://www.filestack.com/docs/api/file#store)\n   * @param url       Valid URL to a file.\n   * @param options   Configure file storage.\n   * @param token     Optional control token to call .cancel()\n   * @param security  Optional security override.\n   */\n\n\n  Client.prototype.storeURL = function (url, options, token, security) {\n    /* istanbul ignore next */\n    return storeURL(this.session, url, options, token, security);\n  };\n  /**\n   * Access files via their Filestack handles.\n   *\n   * If head option is provided - request headers are returned in promise\n   * If metadata option is provided - metadata object is returned in promise\n   * Otherwise file blob is returned\n   * Metadata and head options cannot be mixed\n   *\n   * ### Example\n   *\n   * ```js\n   * client.retrieve('fileHandle', {\n   *  metadata: true,\n   * }).then((response) => {\n   *  console.log(response);\n   * }).catch((err) => {\n   *  console.error(err);\n   * })\n   * ```\n   *\n   * @see [File API - Download](https://www.filestack.com/docs/api/file#download)\n   * @param handle    Valid file handle\n   * @param options   RetrieveOptions\n   * @param security  Optional security override.\n   * @throws          Error\n   */\n\n\n  Client.prototype.retrieve = function (handle, options, security) {\n    /* istanbul ignore next */\n    return retrieve(this.session, handle, options, security);\n  };\n  /**\n   * Interface to the Filestack [Processing API](https://www.filestack.com/docs/api/processing).\n   * Convert a URL, handle, or storage alias to another URL which links to the transformed file.\n   * You can optionally store the returned URL with client.storeURL.\n   *\n   * Transform params can be provided in camelCase or snakeCase style ie: partial_pixelate or partialPixelate\n   *\n   * ### Example\n   *\n   * ```js\n   * const transformedUrl = client.transform(url, {\n   *   crop: {\n   *     dim: [x, y, width, height],\n   *   },\n   *   vignette: {\n   *     blurmode: 'gaussian',\n   *     amount: 50,\n   *   },\n   *   flip: true,\n   *   partial_pixelate: {\n   *     objects: [[10, 20, 200, 250], [275, 91, 500, 557]],\n   *   },\n   * };\n   *\n   * // optionally store the new URL\n   * client.storeURL(transformedUrl).then(res => console.log(res));\n   * ```\n   * @see [Filestack Processing API](https://www.filestack.com/docs/api/processing)\n   * @param url     Single or multiple valid URLs (http(s)://), file handles, or storage aliases (src://) to an image.\n   * @param options Transformations are applied in the order specified by this object.\n   * @param b64     Use new more safe format for generating transforms url (default=false) Note: If there will be any issues with url please test it with enabled b64 support\n   * @returns       A new URL that points to the transformed resource.\n   */\n\n\n  Client.prototype.transform = function (url, options, b64) {\n    if (b64 === void 0) {\n      b64 = false;\n    }\n    /* istanbul ignore next */\n\n\n    return transform(this.session, url, options, b64);\n  };\n  /**\n   * Initiates a multi-part upload flow. Use this for Filestack CIN and FII uploads.\n   *\n   * In Node runtimes the file argument is treated as a file path.\n   * Uploading from a Node buffer is not yet implemented.\n   *\n   * ### Example\n   *\n   * ```js\n   * const token = {};\n   * const onRetry = (obj) => {\n   *   console.log(`Retrying ${obj.location} for ${obj.filename}. Attempt ${obj.attempt} of 10.`);\n   * };\n   *\n   * client.upload(file, { onRetry }, { filename: 'foobar.jpg' }, token)\n   *   .then(res => console.log(res));\n   *\n   * client.upload({file, name}, { onRetry }, { filename: 'foobar.jpg' }, token)\n   *   .then(res => console.log(res));\n   *\n   * token.pause();  // Pause flow\n   * token.resume(); // Resume flow\n   * token.cancel(); // Cancel flow (rejects)\n   * ```\n   * @param {InputFile}    file           Must be a valid [File | Blob | Buffer | string]\n   * @param uploadOptions  Uploader options.\n   * @param storeOptions   Storage options.\n   * @param token          A control token that can be used to call cancel(), pause(), and resume().\n   * @param security       Optional security policy and signature override.\n   *\n   * @returns {Promise}\n   */\n\n\n  Client.prototype.upload = function (file, options, storeOptions, token, security) {\n    var _this = this;\n\n    var upload = new Upload(options, storeOptions);\n    upload.setSession(this.session);\n\n    if (token) {\n      upload.setToken(token);\n    }\n\n    if (security) {\n      upload.setSecurity(security);\n    }\n    /* istanbul ignore next */\n\n\n    upload.on('error', function (e) {\n      Sentry.withScope(function (scope) {\n        scope.setExtras(e.details);\n        scope.setExtras({\n          uploadOptions: options,\n          storeOptions: storeOptions\n        });\n        Sentry.captureException(e);\n      });\n\n      _this.emit('upload.error', e);\n    });\n    return upload.upload(file);\n  };\n  /**\n   * Initiates a multi-part upload flow. Use this for Filestack CIN and FII uploads.\n   *\n   * In Node runtimes the file argument is treated as a file path.\n   * Uploading from a Node buffer is not yet implemented.\n   *\n   * ### Example\n   *\n   * ```js\n   * const token = {};\n   * const onRetry = (obj) => {\n   *   console.log(`Retrying ${obj.location} for ${obj.filename}. Attempt ${obj.attempt} of 10.`);\n   * };\n   *\n   * client.multiupload([file], { onRetry }, token)\n   *   .then(res => console.log(res));\n   *\n   * client.multiupload([{file, name}], { onRetry }, token)\n   *   .then(res => console.log(res));\n   *\n   * token.pause();  // Pause flow\n   * token.resume(); // Resume flow\n   * token.cancel(); // Cancel flow (rejects)\n   * ```\n   * @param {InputFile[]}  file           Must be a valid [File | Blob | Buffer | string (base64)]\n   * @param uploadOptions  Upload options.\n   * @param storeOptions   Storage options.\n   * @param token          A control token that can be used to call cancel(), pause(), and resume().\n   * @param security       Optional security policy and signature override.\n   *\n   * @returns {Promise}\n   */\n\n\n  Client.prototype.multiupload = function (file, options, storeOptions, token, security) {\n    var _this = this;\n\n    var upload = new Upload(options, storeOptions);\n    upload.setSession(this.session);\n\n    if (token) {\n      upload.setToken(token);\n    }\n\n    if (security) {\n      upload.setSecurity(security);\n    }\n    /* istanbul ignore next */\n\n\n    upload.on('error', function (e) {\n      Sentry.withScope(function (scope) {\n        scope.setExtras(e.details);\n        scope.setExtras({\n          uploadOptions: options,\n          storeOptions: storeOptions\n        });\n        Sentry.captureException(e);\n      });\n\n      _this.emit('upload.error', e);\n    });\n    return upload.multiupload(file);\n  };\n\n  return Client;\n}(EventEmitter);\n\nexport { Client };","map":null,"metadata":{},"sourceType":"module"}